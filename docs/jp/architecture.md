# ブログのアーキテクチャとデータフロー

このドキュメントでは、Markdown ファイルから静的なブログコンテンツを効率的に生成および表示するように設計されたブログアプリケーションのアーキテクチャとデータフローについて説明します。

## 1. コンポーネントとレイヤー

このブログは、以下の主要なコンポーネントとレイヤーで構成されています。

*   **コンテンツ層 (`/contents/`)**:
    *   ブログ記事のソースとなる Markdown ファイルが保存される場所です。各ファイルには、「フロントマター」（タイトル、日付、著者などのメタデータ）と、記事の主要な Markdown コンテンツが含まれます。

*   **データアクセス層 (`lib/posts.ts`)**:
    *   このレイヤーは、ファイルシステムから Markdown ファイルを読み込み、処理するための抽象化を提供します。
    *   **`getSortedPostsData()`**: すべての Markdown ファイルを読み込み、そのフロントマターを解析し、ソートされた記事のメタデータ（スラッグ、タイトル、日付、著者）のリストを返します。
    *   **`getPostData(slug)`**: 特定のスラッグに対応する Markdown ファイルを読み込み、そのフロントマターを解析し、Markdown コンテンツを HTML に変換して、記事の完全なデータ（メタデータと HTML コンテンツ）を返します。
    *   **`getAllPostSlugs()`**: すべての Markdown ファイルのスラッグ（ファイル名）のリストを返します。
    *   **内部動作**: `fs` モジュールを使用してファイルを読み込み、`gray-matter` でフロントマターを解析し、`remark` と `remark-html` を使用して Markdown を HTML に変換します。返されるデータは、Next.js のシリアライゼーションの問題を避けるため、日付を含むすべてのプロパティがプレーンな文字列として扱われるようにします。

*   **プレゼンテーション層 (Next.js App Router Pages)**:
    *   このレイヤーは、データアクセス層から取得したデータに基づいてユーザーインターフェースをレンダリングする役割を担います。
    *   **`src/app/page.tsx` (ホームページ)**:
        *   ビルド時に `getSortedPostsData()` を呼び出して、すべてのブログ記事のメタデータを取得します。
        *   記事のタイトルと日付のリストを表示し、各記事へのリンクを提供します。
    *   **`src/app/posts/[slug]/page.tsx` (記事詳細ページ)**:
        *   **`generateStaticParams()`**: `getAllPostSlugs()` を呼び出すことで、利用可能なすべての `[slug]` 値（つまり、どの記事が存在するか）を Next.js に通知します。
        *   **`Post` コンポーネント**: 各スラッグに対して、ビルド時に `getPostData(slug)` を呼び出して、特定の記事の完全なコンテンツを取得します。
        *   取得したデータ（タイトル、日付、著者、HTML コンテンツ）をレンダリングして、個々の記事ページを生成します。

*   **レイアウト/スタイリング層 (`src/app/layout.tsx`, `globals.css`, Tailwind CSS)**:
    *   アプリケーション全体で一貫したユーザーインターフェースとスタイリングを提供します。
    *   **`src/app/layout.tsx`**: ヘッダー、メインコンテンツ領域、フッターなど、すべてのページに適用される共通のレイアウトを定義します。
    *   **`globals.css` と Tailwind CSS**: アプリケーションの視覚的なスタイリングを処理します。

## 2. データフロー (ステップバイステップ)

データは主に**ビルド時**に静的な HTML ファイルとして処理および生成されます。

*   **ビルド時 (静的サイト生成 - SSG)**:
    1.  `pnpm run build` コマンドが実行され、Next.js のビルドプロセスが開始されます。
    2.  **ホームページ (`/`) の生成**:
        *   Next.js は `src/app/page.tsx` を処理します。
        *   `src/app/page.tsx` 内で `getSortedPostsData()` が呼び出されます。
        *   `getSortedPostsData()` は `/contents/` ディレクトリからすべての `.md` ファイルを読み込み、そのフロントマターを解析し、Markdown を HTML に変換し、日付を文字列としてフォーマットした記事メタデータの配列を返します。
        *   Next.js はこのデータを受け取り、ホームページの静的な HTML をプリレンダリングします。
    3.  **記事詳細ページ (`/posts/[slug]`) の生成**:
        *   Next.js は `src/app/posts/[slug]/page.tsx` を処理します。
        *   まず、`generateStaticParams()` が呼び出され、`getAllPostSlugs()` を介して `/contents/` 内の `.md` ファイル名から利用可能なすべての `slug` 値（例: `first-post`）のリストを取得します。
        *   取得した各 `slug` に対して、Next.js は `getPostData(slug)` を呼び出します。
        *   `getPostData(slug)` は対応する `.md` ファイルを読み込み、そのフロントマターを解析し、Markdown コンテンツを HTML に変換して、記事の完全なデータ（メタデータと HTML コンテンツ）を返します。
        *   Next.js はこのデータを受け取り、個々の記事ページの静的な HTML をプリレンダリングします。
    4.  すべてのページは、静的な HTML ファイルとして `.next` ディレクトリに出力されます。

*   **実行時 (クライアントサイド)**:
    1.  ユーザーがブラウザでページをリクエストします。
    2.  Next.js は、プリレンダリングされた静的な HTML ファイルをユーザーのブラウザに提供します。
    3.  クライアントサイドの JavaScript は、ページを「ハイドレート」（動的な機能を追加）し、リンクのクリックなどのインタラクティブな操作を可能にします。

## 3. 主要なアーキテクチャ原則

*   **関心の分離**: コンテンツ（Markdown ファイル）、データアクセスロジック（`lib/posts.ts`）、プレゼンテーション（Next.js コンポーネント）が明確に分離されています。
*   **静的サイト生成 (SSG)**: すべてのページはビルドプロセス中に事前に構築されるため、高いパフォーマンス、優れた SEO、およびセキュリティが実現されます。
*   **データ抽象化**: `lib/posts.ts` は、ファイルシステム操作と Markdown 解析の複雑さを隠蔽し、コンポーネントがクリーンで構造化されたデータを受け取れるようにします。
*   **動的ルーティング**: 単一のコンポーネント (`src/app/posts/[slug]/page.tsx`) で複数の記事ページを効率的に処理します。
*   **スケーラビリティ**: 新しい記事を追加するには、新しい Markdown ファイルを `/contents/` ディレクトリに配置するだけでよく、コードの変更は不要です。